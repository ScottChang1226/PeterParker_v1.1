<!DOCTYPE html>
<head>

<!-- Basic Page Needs
================================================== -->
<title>PETER.PARKER</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<!-- CSS
    ================================================== -->
	<link rel="stylesheet" href="css/style.css">
	<link rel="stylesheet" href="css/main-color.css" id="colors">
<!--	<script type="module" src="scripts/userinfo.js"></script>-->
<!--	<script type="module" src="scripts/get_photo.js"></script>-->

</head>

<body>

<!-- Wrapper -->
<div id="wrapper">

	<!-- Header Container
    ================================================== -->
	<header id="header-container" class="fullwidth dashboard">

		<!-- Header -->
		<div id="header" class="not-sticky">
			<div class="container">

				<!-- Left Side Content -->
				<div class="left-side">

					<!-- Logo -->
					<div id="logo">
						<a href="index.html"><img src="images/logo.png" alt=""></a>
						<a href="index.html" class="dashboard-logo"><img src="images/logo2.png" alt=""></a>
					</div>

					<!-- Mobile Navigation -->
					<div class="mmenu-trigger">
						<button class="hamburger hamburger--collapse" type="button">
						<span class="hamburger-box">
							<span class="hamburger-inner"></span>
						</span>
						</button>
					</div>

					<!-- Main Navigation -->
					<nav id="navigation" class="style-1">
						<ul id="responsive">

							<li><a href="index.html">首頁</a>
							</li>

							<li><a>如何使用</a>
								<ul>
									<li><a href="how_to_reserve.html">如何預約車位</a></li>
									<li><a href="dashboard-messages.html">如何出租車位</a></li>
								</ul>
							</li>

							<li><a>最新消息</a>
								<ul>
									<li><a href="dashboard.html">Dashboard</a></li>
									<li><a href="dashboard-messages.html">Messages</a></li>
									<li><a href="dashboard-bookings.html">Bookings</a></li>
									<li><a href="dashboard-wallet.html">Wallet</a></li>
									<li><a href="dashboard-my-listings.html">My Listings</a></li>
									<li><a href="dashboard-reviews.html">Reviews</a></li>
									<li><a href="dashboard-bookmarks.html">Bookmarks</a></li>
									<li><a href="dashboard-add-listing.html">Add Listing</a></li>
									<li><a href="dashboard-my-profile.html">My Profile</a></li>
									<li><a href="dashboard-invoice.html">Invoice</a></li>
								</ul>
							</li>

							<li><a href="#">聯絡我們</a></li>

							<li><a href="#">業主登入</a></li>


						</ul>
					</nav>
					<div class="clearfix"></div>
					<!-- Main Navigation / End -->

				</div>
				<!-- Left Side Content / End -->

				<!-- Right Side Content / End-->
				<div class="right-side">
					<!-- Header Widget -->
					<div class="header-widget">
						<!-- User Menu -->
						<div class="user-menu">
							<div class="user-name"><span><img id="avatar-preview" src="images/dashboard-avatar.jpg" alt=""></span><p style="display:inline "id="username2"></p></div>
							<ul>
								<li><a href="user_center.html"><i class="sl sl-icon-settings"></i>會員中心</a></li>
								<li><a href="user_profile.html"><i class="sl sl-icon-user"></i>會員個人資料</a></li>
							</ul>
						</div>
						<a href="index.html" id="logout_btn" class="button border with-icon" onclick="localStorage.removeItem('peterParkerToken'); localStorage.removeItem('userId');"></i>會員登出</a>
					</div>
				</div>
			</div>
			<!-- Header Widget / End -->
		</div>
		<!-- Right Side Content / End -->

</header>
<!-- Header / End -->
<div class="clearfix"></div>
<!-- Header Container / End -->


<!-- Content
================================================== -->
<div class="fs-container">

	<div class="fs-inner-container content">
		<div class="fs-content">

			<!-- Search -->
			<section class="search">

				<div class="row">
					<div class="col-md-12">

							<!-- Row With Forms -->
							<div class="row with-forms">

								<!-- Main Search Input -->
								<div class="col-fs-6">
									<div class="input-with-icon">
										<i class="sl sl-icon-magnifier"></i>
										<input type="text" placeholder="想停哪裡?" value=""/>
									</div>
								</div>

								<!-- Main Search Input -->
								<div class="col-fs-6">
									<div class="input-with-icon location">
										<div id="autocomplete-container">
											<input id="autocomplete-input" type="text" placeholder="尋找附近的車位">
										</div>
										<a href="#"><i class="fa fa-map-marker"></i></a>
									</div>
								</div>
						

								<!-- Filters -->
								<div class="col-fs-12">

									<!-- Panel Dropdown / End -->
									<div class="panel-dropdown">
										<a href="#">類型</a>
										<div class="panel-dropdown-content checkboxes categories">
											
											<!-- Checkboxes -->
											<div class="row">
												<div class="col-md-6">
													<input id="check-1" type="checkbox" name="check" checked class="all">
													<label for="check-1">全部</label>

													<input id="check-2" type="checkbox" name="check">
													<label for="check-2">平面停車場</label>

													<input id="check-3" type="checkbox" name="check">
													<label for="check-3">立體停車場</label>

													<input id="check-4" type="checkbox" name="check">
													<label for="check-4">地下停車場</label>
												</div>	

											</div>
											
											<!-- Buttons -->
											<div class="panel-buttons">
												<button class="panel-cancel">取消</button>
												<button class="panel-apply">接受</button>
											</div>

										</div>
									</div>
									<!-- Panel Dropdown / End -->

									<!-- Panel Dropdown -->
									<div class="panel-dropdown wide">
										<a href="#">更多</a>
										<div class="panel-dropdown-content checkboxes">

											<!-- Checkboxes -->
											<div class="row">
												<div class="col-md-6">
													<input id="check-a" type="checkbox" name="check"  checked class="all">
													<label for="check-a">全部</label>

													<input id="check-b" type="checkbox" name="check">
													<label for="check-b">目前剩餘車位超過10</label>

													<input id="check-c" type="checkbox" name="check">
													<label for="check-c">目前剩餘車位少於10</label>

												</div>	

											</div>
											
											<!-- Buttons -->
											<div class="panel-buttons">
												<button class="panel-cancel">取消</button>
												<button class="panel-apply">接受</button>
											</div>

										</div>
									</div>
									<!-- Panel Dropdown / End -->

									<!-- Panel Dropdown -->
									<div class="panel-dropdown">
										<a href="#">距離</a>
										<div class="panel-dropdown-content">
											<input class="distance-radius" type="range" min="1" max="100" step="1" value="50" data-title="顯示所在位置半徑距離內的停車場">
											<div class="panel-buttons">
												<button class="panel-cancel">取消</button>
												<button class="panel-apply">接受</button>
											</div>
										</div>
									</div>
									<!-- Panel Dropdown / End -->
									
								</div>
								<!-- Filters / End -->
	
							</div>
							<!-- Row With Forms / End -->

					</div>
				</div>

			</section>
			<!-- Search / End -->


		<section class="listings-container margin-top-30">
			<!-- Sorting / Layout Switcher -->
			<div class="row fs-switcher">

				<div class="col-md-6">
					<!-- Showing Results -->
					<p class="showing-results">共找到14個結果</p>
				</div>

			</div>


			<!-- Listings -->
			<div class="row fs-listings">
				
				<!-- Listing Item -->
				<div class="col-lg-12 col-md-12">
					<div class="listing-item-container list-layout" data-marker-id="1">
						<a href="parking_booking_1.html" class="listing-item">
							
							<!-- Image -->
							<div class="listing-item-image">
								<img src="images/Parking_pic/螢幕擷取畫面 2024-09-30 184944.jpg" alt="">
								<span class="tag">地下停車場</span>
							</div>
							
							<!-- Content -->
							<div class="listing-item-content">
								<div class="listing-badge now-open">24小時共享</div>

								<div class="listing-item-inner">
									<h3>CITY PARKING 城市車旅停車場 國泰南京商業大樓站 <i class="verified-icon"></i></h3>
									<h4>50元
										<span>/小時</span>
									</h4>
									<span>(限小車)(非低底盤)</span>
									<div class="star-rating" data-rating="3.5">
										<div class="rating-counter">(12 則評論)</div>
									</div>
								</div>

								
								<span class="like-icon"></span>
							</div>
						</a>
						
					</div>
				</div>
				<!-- Listing Item / End -->

				<!-- Listing Item -->
				<div class="col-lg-12 col-md-12">
					<div class="listing-item-container list-layout" data-marker-id="2">
						<a href="listings-single-page.html" class="listing-item">
							
							<!-- Image -->
							<div class="listing-item-image">
								<img src="images/listing-item-02.jpg" alt="">
								<span class="tag">平面停車場</span>
							</div>
							
							<!-- Content -->
							<div class="listing-item-content">

								<div class="listing-item-inner">
								<h3>Sticky Band</h3>
								<span>Bishop Avenue, New York</span>
									<div class="star-rating" data-rating="5.0">
										<div class="rating-counter">(23 reviews)</div>
									</div>
								</div>

								<span class="like-icon"></span>

								<div class="listing-item-details">Friday, August 10</div>
							</div>
						</a>
					</div>
				</div>
				<!-- Listing Item / End -->

				<!-- Listing Item -->
				<div class="col-lg-12 col-md-12">
					<div class="listing-item-container list-layout" data-marker-id="3">
						<a href="listings-single-page.html" class="listing-item">
							
							<!-- Image -->
							<div class="listing-item-image">
								<img src="images/listing-item-03.jpg" alt="">
								<span class="tag">Hotels</span>
							</div>
							
							<!-- Content -->
							<div class="listing-item-content">

								<div class="listing-item-inner">
								<h3>Hotel Govendor</h3>
								<span>778 Country Street, New York</span>
									<div class="star-rating" data-rating="2.0">
										<div class="rating-counter">(17 reviews)</div>
									</div>
								</div>

								<span class="like-icon"></span>

								<div class="listing-item-details">Starting from $59 per night</div>
							</div>
						</a>
					</div>
				</div>
				<!-- Listing Item / End -->

				<!-- Listing Item -->
				<div class="col-lg-12 col-md-12">
					<div class="listing-item-container list-layout" data-marker-id="4">
						<a href="listings-single-page.html" class="listing-item">
							
							<!-- Image -->
							<div class="listing-item-image">
								<img src="images/listing-item-04.jpg" alt="">
								<span class="tag">Eat & Drink</span>
							</div>
							
							<!-- Content -->
							<div class="listing-item-content">
								<div class="listing-badge now-open">Now Open</div>
								
								<div class="listing-item-inner">
								<h3>Burger House <i class="verified-icon"></i></h3>
								<span>2726 Shinn Street, New York</span>
									<div class="star-rating" data-rating="5.0">
										<div class="rating-counter">(31 reviews)</div>
									</div>
								</div>

								<span class="like-icon"></span>
							</div>
						</a>
					</div>
				</div>
				<!-- Listing Item / End -->

				<!-- Listing Item -->
				<div class="col-lg-12 col-md-12">
					<div class="listing-item-container list-layout" data-marker-id="5">
						<a href="listings-single-page.html" class="listing-item">
							
							<!-- Image -->
							<div class="listing-item-image">
								<img src="images/listing-item-05.jpg" alt="">
								<span class="tag">Other</span>
							</div>
							
							<!-- Content -->
							<div class="listing-item-content">

								<div class="listing-item-inner">
								<h3>Airport</h3>
								<span>1512 Duncan Avenue, New York</span>
									<div class="star-rating" data-rating="3.5">
										<div class="rating-counter">(46 reviews)</div>
									</div>
								</div>

								<span class="like-icon"></span>
							</div>
						</a>
					</div>
				</div>
				<!-- Listing Item / End -->

				<!-- Listing Item -->
				<div class="col-lg-12 col-md-12">
					<div class="listing-item-container list-layout" data-marker-id="6">
						<a href="listings-single-page.html" class="listing-item">
							
							<!-- Image -->
							<div class="listing-item-image">
								<img src="images/listing-item-06.jpg" alt="">
								<span class="tag">Eat & Drink</span>
							</div>
							
							<!-- Content -->
							<div class="listing-item-content">
								<div class="listing-badge now-closed">Now Closed</div>

								<div class="listing-item-inner">
								<h3>Think Coffee</h3>
								<span>215 Terry Lane, New York</span>
									<div class="star-rating" data-rating="5.0">
										<div class="rating-counter">(31 reviews)</div>
									</div>
								</div>

								<span class="like-icon"></span>
							</div>
						</a>
					</div>
				</div>
				<!-- Listing Item / End -->

			</div>
			<!-- Listings Container / End -->


			<!-- Pagination Container -->
			<div class="row fs-listings">
				<div class="col-md-12">

					<!-- Pagination -->
					<div class="clearfix"></div>
					<div class="row">
						<div class="col-md-12">
							<!-- Pagination -->
							<div class="pagination-container margin-top-15 margin-bottom-40">
								<nav class="pagination">
									<ul>
										<li><a href="#" class="current-page">1</a></li>
										<li><a href="#">2</a></li>
										<li><a href="#">3</a></li>
										<li><a href="#"><i class="sl sl-icon-arrow-right"></i></a></li>
									</ul>
								</nav>
							</div>
						</div>
					</div>
					<div class="clearfix"></div>
					<!-- Pagination / End -->
					
					<!-- Copyrights -->
					<div class="copyrights margin-top-0">© 2021 Listeo. All Rights Reserved.</div>

				</div>
			</div>
			<!-- Pagination Container / End -->
		</section>

		</div>
	</div>
	<div class="fs-inner-container map-fixed">
		<!-- Map -->
		<div id="map-container">
			<div id="map" data-map-zoom="9" data-map-scroll="true" style="height: 100%; width: 100%;">
				<!-- map goes here -->
			</div>
		</div>
	</div>
</div>


</div>
<!-- Wrapper / End -->


<!-- Scripts
================================================== -->
<script type="text/javascript" src="scripts/jquery-3.6.0.min.js"></script>
<script type="text/javascript" src="scripts/jquery-migrate-3.3.2.min.js"></script>
<script type="text/javascript" src="scripts/mmenu.min.js"></script>
<script type="text/javascript" src="scripts/chosen.min.js"></script>
<script type="text/javascript" src="scripts/slick.min.js"></script>
<script type="text/javascript" src="scripts/rangeslider.min.js"></script>
<script type="text/javascript" src="scripts/magnific-popup.min.js"></script>
<script type="text/javascript" src="scripts/waypoints.min.js"></script>
<script type="text/javascript" src="scripts/counterup.min.js"></script>
<script type="text/javascript" src="scripts/jquery-ui.min.js"></script>
<script type="text/javascript" src="scripts/tooltips.min.js"></script>
<script type="text/javascript" src="scripts/custom.js"></script>

<!-- Google Autocomplete -->
<script>
	var googleMap;
	var markers = [];
	var infoWindow;

	function initMap() {
		// Initialize the Google Map
		googleMap = new google.maps.Map(document.getElementById('map'), {
			center: { lat: 25.0330, lng: 121.5654 }, // Taipei default center
			zoom: 13,
			scrollwheel: true,
			mapId:'DEMO_MAP_ID'
		});

		// console.log('asdasdasd');
		// let marker = new google.maps.marker.AdvancedMarkerElement({
		// 	map:googleMap,
		// 	position: { lat: 25.042, lng: 121.56 },
		// 	title: "asdasdasd",
		// });
		// console.log('asdasdasd');

		infoWindow = new google.maps.InfoWindow();

		// Initialize autocomplete
		initAutocomplete();

		// Fetch initial parking data and place markers
		fetchAndDisplayParking();

		// Listen to map changes and fetch parking data accordingly
		google.maps.event.addListener(googleMap, 'bounds_changed', function() {
			fetchAndDisplayParking();
		});
	}

	function initAutocomplete() {
		var input = document.getElementById('autocomplete-input');
		var autocomplete = new google.maps.places.Autocomplete(input);

		autocomplete.addListener('place_changed', function() {
			var place = autocomplete.getPlace();
			if (!place.geometry) {
				return;
			}

			// Center the map to the selected place
			googleMap.setCenter(place.geometry.location);
			googleMap.setZoom(15);

			// Fetch and display nearby parking
			fetchAndDisplayParking();
		});

		if ($('.main-search-input-item')[0]) {
			setTimeout(function() {
				$(".pac-container").prependTo("#autocomplete-container");
			}, 300);
		}
	}

	function fetchAndDisplayParking() {
		// Assuming the back-end API provides filtered parking listings based on current map bounds
		var bounds = googleMap.getBounds();
		if (!bounds) return;

		var ne = bounds.getNorthEast();
		var sw = bounds.getSouthWest();

		fetch('/api/getParkingListings', {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json',
			},
			body: JSON.stringify({
				northEast: { lat: ne.lat(), lng: ne.lng() },
				southWest: { lat: sw.lat(), lng: sw.lng() },
			})
		})
				.then(response => {
					if (!response.ok) {
						throw new Error('Network response was not ok');
					}
					return response.json();
				})
				.then(data => {
					clearMarkers(); // Clear previous markers
					data.forEach(parking => {
						createMarker(parking);
					});
				})
				.catch(error => {
					console.error('Error fetching parking listings:', error);
				});
	}

	function createMarker(parking) {
		var marker = new google.maps.Marker({
			map: googleMap,
			position: { lat: parking.parkingLat, lng: parking.parkingLong },
			title: parking.parkingName,
		});

		marker.addListener('click', function() {
			infoWindow.setContent(`
                <div class="infobox-content">
                    <h5>${parking.parkingName}</h5>
                    <p>${parking.parkingLocation}</p>
                    <p>Hourly Rate: $${parking.workdayHourlyRate}</p>
                    <a href="parking_booking_1.html?parkingId=${parking.parkingId}">Book Now</a>
                </div>
            `);
			infoWindow.open(googleMap, marker);
		});

		markers.push(marker);
	}

	function clearMarkers() {
		markers.forEach(marker => {
			marker.setMap(null);
		});
		markers = [];
	}
</script>
<script async defer
		src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDm8zpLXPf2UtxecZZmABNScrbKfa31AIQ&libraries=places,marker&callback=initMap">
</script>


<!-- Load Google Maps -->
<!--<script type="text/javascript" src="scripts/infobox.min.js"></script>-->
<script type="text/javascript" src="scripts/markerclusterer.js"></script>
<!--<script type="text/javascript" src="scripts/maps.js"></script>-->

<!-- Add new JavaScript code here -->
<script>

	$(document).ready(function () {


		// 搜尋功能 AJAX 請求
		$('#autocomplete-input').on('change', function () {
			let keyword = $(this).val();
			if (keyword) {
				$.ajax({
					url: '/order/searchParking',
					type: 'GET',
					data: {keyword: keyword},
					success: function (data) {
						renderParkingList(data);
					},
					error: function (err) {
						console.error('Error searching parking:', err);
					}
				});
			} else {
				// 如果輸入為空，顯示所有可用的停車場或提示訊息
				console.warn('Please enter a keyword for searching.');
			}
		});

		// 篩選功能 AJAX 請求
		$('.distance-radius').on('input', function () {
			let radius = $(this).val();
			// 使用地圖的當前中心經緯度作為篩選條件
			let center = googleMap.getCenter();
			let latitude = center.lat();
			let longitude = center.lng();

			$.ajax({
				url: '/order/nearbyParking',
				type: 'GET',
				data: {
					latitude: latitude,
					longitude: longitude,
					radius: radius
				},
				success: function (data) {
					renderParkingList(data);
				},
				error: function (err) {
					console.error('Error finding nearby parking:', err);
				}
			});
		});





		// 篩選按鈕點擊事件
		document.getElementById('apply-filters').addEventListener('click', function () {
			// 獲取選擇的篩選條件
			var selectedTypes = [];
			document.querySelectorAll('.filter-option:checked').forEach(function (checkbox) {
				selectedTypes.push(checkbox.value);
			});

			var distance = document.querySelector('.distance-radius').value;

			// 調用後端 API，根據篩選條件獲取停車場列表
			fetchFilteredParkingListings(selectedTypes, distance);
		});

		// 向後端發送篩選條件並獲取停車場列表
		function fetchFilteredParkingListings(types, distance) {
			fetch('/api/getFilteredParkingListings', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
				},
				body: JSON.stringify({
					types: types,
					distance: distance
				})
			})
					.then(response => {
						if (!response.ok) {
							throw new Error('Network response was not ok');
						}
						return response.json();
					})
					.then(data => {
						renderParkingList(data); // 使用後端返回的資料渲染列表
					})
					.catch(error => {
						console.error('Error fetching filtered parking listings:', error);
					});
		}

		// 渲染停車場列表的函數
		function renderParkingList(parkingData) {
			var listingResults = document.getElementById('listing-results');
			listingResults.innerHTML = ''; // 清除原有內容

			if (parkingData.length === 0) {
				listingResults.innerHTML = '<p>未找到符合條件的停車場。</p>';
			} else {
				parkingData.forEach(function (parking, index) {

					// The advanced marker, positioned at Uluru
					let marker = new google.maps.marker.AdvancedMarkerElement({
						map: googleMap,
						position: parking.postion,
						title: parking.parkingName,
					});

					var listingItem = `
                <div class="col-lg-12 col-md-12">
                    <div class="listing-item-container list-layout" data-marker-id="${index + 1}">
                        <a href="parking_booking_1.html?parkingId=${parking.parkingId}" class="listing-item">
                            <!-- Image -->
                            <div class="listing-item-image">
                                <img src="${parking.parkingImg}" alt="">
                                <span class="tag">${parking.parkingType}</span>
                            </div>
                            <!-- Content -->
                            <div class="listing-item-content">
                                <div class="listing-item-inner">
                                    <h3>${parking.parkingName} <i class="verified-icon"></i></h3>
                                    <h4>${parking.hourlyRate}元<span>/小時</span></h4>
                                    <div class="star-rating" data-rating="${parking.rating}">
                                        <div class="rating-counter">(${parking.reviewCount} 則評論)</div>
                                    </div>
                                </div>
                                <span class="like-icon"></span>
                            </div>
                        </a>
                    </div>
                </div>
            `;
					listingResults.insertAdjacentHTML('beforeend', listingItem);
				});
			}

			document.getElementById('showing-results').textContent = `共找到${parkingData.length}個結果`;
		}
	})

</script>

<!--
<script>
	window.onload = function() {
		// Check if the jwt_token exists in localStorage
		let token = localStorage.getItem('peterParkerToken');

		// If no token is found, redirect to index.html
		if (!token) {
			window.location.href = 'index.html';
		}

		// Optionally, you can also check if the token has a valid format or expiration time
		// if your application uses such validation on the client-side.
	};
</script>
-->

</body>
</html>

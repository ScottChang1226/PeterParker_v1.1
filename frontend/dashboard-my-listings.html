<!DOCTYPE html>
<head>

<!-- Basic Page Needs
================================================== -->
<title>Listeo</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

<!-- CSS
================================================== -->
<link rel="stylesheet" href="css/style.css">
<link rel="stylesheet" href="css/main-color.css" id="colors">





</head>

<body>

<!-- Wrapper -->
<div id="wrapper">

<!-- Header Container
================================================== -->
<header id="header-container" class="fixed fullwidth dashboard">

	<!-- Header -->
	<div id="header" class="not-sticky">
		<div class="container">
			
			<!-- Left Side Content -->
			<div class="left-side">
				
				<!-- Logo -->
				<div id="logo">
					<a href="index.html"><img src="images/logo.png" alt=""></a>
					<a href="index.html" class="dashboard-logo"><img src="images/logo2.png" alt=""></a>
				</div>

				<!-- Mobile Navigation -->
				<div class="mmenu-trigger">
					<button class="hamburger hamburger--collapse" type="button">
						<span class="hamburger-box">
							<span class="hamburger-inner"></span>
						</span>
					</button>
				</div>

				<!-- Main Navigation -->
				<nav id="navigation" class="style-1">
					<ul id="responsive">

						<li><a href="#">Home</a>
							<ul>
								<li><a href="index.html">Home 1 (Modern)</a></li>
								<li><a href="index-2.html">Home 2 (Default)</a></li>
								<li><a href="index-3.html">Home 3 (Airbnb)</a></li>
								<li><a href="index-4.html">Home 4 (Creative)</a></li>
								<li><a href="index-5.html">Home 5 (Slider)</a></li>
								<li><a href="index-6.html">Home 6 (Map)</a></li>
								<li><a href="index-7.html">Home 7 (Video)</a></li>
								<li><a href="index-8.html">Home 8 (Classic)</a></li>
							</ul>
						</li>

						<li><a href="#">Listings</a>
							<ul>
								<li><a href="#">List Layout</a>
									<ul>
										<li><a href="listings-list-with-sidebar.html">With Sidebar</a></li>
										<li><a href="listings-list-full-width.html">Full Width</a></li>
										<li><a href="listings-list-full-width-with-map.html">Full Width + Map</a></li>
									</ul>
								</li>
								<li><a href="#">Grid Layout</a>
									<ul>
										<li><a href="listings-grid-with-sidebar-1.html">With Sidebar 1</a></li>
										<li><a href="listings-grid-with-sidebar-2.html">With Sidebar 2</a></li>
										<li><a href="listings-grid-full-width.html">Full Width</a></li>
										<li><a href="listings-grid-full-width-with-map.html">Full Width + Map</a></li>
									</ul>
								</li>
								<li><a href="#">Half Screen Map</a>
									<ul>
										<li><a href="listings-half-screen-map-list.html">List Layout</a></li>
										<li><a href="listings-half-screen-map-grid-1.html">Grid Layout 1</a></li>
										<li><a href="listings-half-screen-map-grid-2.html">Grid Layout 2</a></li>
									</ul>
								</li>
								<li><a href="#">Single Listings</a>
									<ul>
										<li><a href="listings-single-page.html">Single Listing 1</a></li>
										<li><a href="listings-single-page-2.html">Single Listing 2</a></li>
										<li><a href="listings-single-page-3.html">Single Listing 3</a></li>
									</ul>
								</li>
								<li><a href="#">Open Street Map</a>
									<ul>
										<li><a href="listings-half-screen-map-list-OpenStreetMap.html">Half Screen Map List Layout</a></li>
										<li><a href="listings-half-screen-map-grid-1-OpenStreetMap.html">Half Screen Map Grid Layout 1</a></li>
										<li><a href="listings-half-screen-map-grid-2-OpenStreetMap.html">Half Screen Map Grid Layout 2</a></li>
										<li><a href="listings-list-full-width-with-map-OpenStreetMap.html">Full Width List</a></li>
										<li><a href="listings-grid-full-width-with-map-OpenStreetMap.html">Full Width Grid</a></li>
										<li><a href="listings-single-page-OpenStreetMap.html">Single Listing</a></li>
									</ul>
								</li>
							</ul>
						</li>

						<li><a class="current" href="#">User Panel</a>
							<ul>
								<li><a href="dashboard.html">Dashboard</a></li>
								<li><a href="dashboard-messages.html">Messages</a></li>
								<li><a href="dashboard-bookings.html">Bookings</a></li>
								<li><a href="dashboard-wallet.html">Wallet</a></li>
								<li><a href="dashboard-my-listings.html">My Listings</a></li>
								<li><a href="dashboard-reviews.html">Reviews</a></li>
								<li><a href="dashboard-bookmarks.html">Bookmarks</a></li>
								<li><a href="dashboard-add-listing.html">Add Listing</a></li>
								<li><a href="dashboard-my-profile.html">My Profile</a></li>
								<li><a href="dashboard-invoice.html">Invoice</a></li>
							</ul>
						</li>

						<li><a href="#">Pages</a>
							<div class="mega-menu mobile-styles three-columns">

									<div class="mega-menu-section">
										<ul>
											<li class="mega-menu-headline">Pages #1</li>
											<li><a href="pages-user-profile.html"><i class="sl sl-icon-user"></i> User Profile</a></li>
											<li><a href="pages-booking.html"><i class="sl sl-icon-check"></i> Booking Page</a></li>
											<li><a href="pages-add-listing.html"><i class="sl sl-icon-plus"></i> Add Listing</a></li>
											<li><a href="pages-blog.html"><i class="sl sl-icon-docs"></i> Blog</a></li>
										</ul>
									</div>
		
									<div class="mega-menu-section">
										<ul>
											<li class="mega-menu-headline">Pages #2</li>
											<li><a href="pages-contact.html"><i class="sl sl-icon-envelope-open"></i> Contact</a></li>
											<li><a href="pages-coming-soon.html"><i class="sl sl-icon-hourglass"></i> Coming Soon</a></li>
											<li><a href="pages-404.html"><i class="sl sl-icon-close"></i> 404 Page</a></li>
											<li><a href="pages-masonry-filtering.html"><i class="sl sl-icon-equalizer"></i> Masonry Filtering</a></li>
										</ul>
									</div>

									<div class="mega-menu-section">
										<ul>
											<li class="mega-menu-headline">Other</li>
											<li><a href="pages-elements.html"><i class="sl sl-icon-settings"></i> Elements</a></li>
											<li><a href="pages-pricing-tables.html"><i class="sl sl-icon-tag"></i> Pricing Tables</a></li>
											<li><a href="pages-typography.html"><i class="sl sl-icon-pencil"></i> Typography</a></li>
											<li><a href="pages-icons.html"><i class="sl sl-icon-diamond"></i> Icons</a></li>
										</ul>
									</div>
									
							</div>
						</li>
						
					</ul>
				</nav>
				<div class="clearfix"></div>
				<!-- Main Navigation / End -->
				
			</div>
			<!-- Left Side Content / End -->

			<!-- Right Side Content / End -->
			<div class="right-side">
				<!-- Header Widget -->
				<div class="header-widget">
					
					<!-- User Menu -->
					<div class="user-menu">
						<div class="user-name"><span><img src="images/dashboard-avatar.jpg" alt=""></span>Hi, Tom!</div>
						<ul>
							<li><a href="dashboard.html"><i class="sl sl-icon-settings"></i> Dashboard</a></li>
							<li><a href="dashboard-messages.html"><i class="sl sl-icon-envelope-open"></i> Messages</a></li>
							<li><a href="dashboard-bookings.html"><i class="fa fa-calendar-check-o"></i> Bookings</a></li>
							<li><a href="index.html"><i class="sl sl-icon-power"></i> Logout</a></li>
						</ul>
					</div>

					<a href="dashboard-add-listing.html" class="button border with-icon">Add Listing <i class="sl sl-icon-plus"></i></a>
				</div>
				<!-- Header Widget / End -->
			</div>
			<!-- Right Side Content / End -->

		</div>
	</div>
	<!-- Header / End -->

</header>
<div class="clearfix"></div>
<!-- Header Container / End -->


<!-- Dashboard -->
<div id="dashboard">

	<!-- Navigation
	================================================== -->

	<!-- Responsive Navigation Trigger -->
	<a href="#" class="dashboard-responsive-nav-trigger"><i class="fa fa-reorder"></i> Dashboard Navigation</a>
	
	<div class="dashboard-nav">
		<div class="dashboard-nav-inner">

			<ul data-submenu-title="Main">
				<li><a href="dashboard.html"><i class="sl sl-icon-settings"></i> 首頁</a></li>
				<li class="active"><a href="dashboard-messages.html"><i class="sl sl-icon-envelope-open"></i> 最新消息 <span class="nav-tag messages">2</span></a></li>
				<li><a href="dashboard-bookings.html"><i class="fa fa-calendar-check-o"></i> 訂單管理</a></li>
				<li><a href="dashboard-wallet.html"><i class="sl sl-icon-wallet"></i> 本月收益</a></li>
			</ul>
			
			<ul data-submenu-title="Listings">
				<li><a><i class="sl sl-icon-layers"></i> 我的停車場</a>
					<ul>
						<li><a href="dashboard-my-listings.html">Active <span class="nav-tag green">6</span></a></li>
						<li><a href="dashboard-my-listings.html">Pending <span class="nav-tag yellow">1</span></a></li>
						<li><a href="dashboard-my-listings.html">Expired <span class="nav-tag red">2</span></a></li>
					</ul>	
				</li>
				<li><a href="dashboard-bookmarks.html"><i class="sl sl-icon-heart"></i> 我的黑名單</a></li>
				<li><a href="dashboard-add-listing.html"><i class="sl sl-icon-plus"></i> 新增停車場</a></li>
			</ul>	

			<ul data-submenu-title="Account">
				<li><a href="dashboard-my-profile.html"><i class="sl sl-icon-user"></i> 個人檔案</a></li>
				<li><a href="index.html"><i class="sl sl-icon-power"></i> 登出</a></li>
			</ul>
		</div>
	</div>
	<!-- Navigation / End -->


	<!-- Content
	================================================== -->
	<div class="dashboard-content">

		<!-- Titlebar -->
		<div id="titlebar">
			<div class="row">
				<div class="col-md-12">
					<h2>My Listings</h2>
					<!-- Breadcrumbs -->
					<nav id="breadcrumbs">
						<ul>
							<li><a href="#">Home</a></li>
							<li><a href="#">Dashboard</a></li>
							<li>My Listings</li>
						</ul>
					</nav>
				</div>
			</div>
		</div>

		<div class="row">
			
			<!-- Listings -->

			<div class="container">
				<h1>Active Listings</h1>
				<div class="dashboard-list-box margin-top-0">
					<h4>Your Parking Spaces</h4>
					<ul class="listings-list">
						<!-- 动态内容将填充在这里 -->
					</ul>
				</div>
			</div>



			<!-- Copyrights -->
			<div class="col-md-12">
				<div class="copyrights">© 2021 Listeo. All Rights Reserved.</div>
			</div>
		</div>

	</div>
	<!-- Content / End -->


</div>
<!-- Dashboard / End -->


</div>
<!-- Wrapper / End -->


<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

<!-- 取得和顯示停車場列表 -->
<script>
    $(document).ready(function() {
        var apiUrl = "http://localhost:8081"; // 替換為你的後端 API 網址
        var defaultImageUrl = "/path/to/default-image.jpg"; // 預設圖片路徑

        // 先取得 session 中的 ownerNo
        $.ajax({
            url: apiUrl + "/owner/ownerNo",
            method: "GET",
            xhrFields: { withCredentials: true },
            success: function(ownerNo) {
                // 使用 ownerNo 發送停車場列表請求
                $.ajax({
                    url: apiUrl + "/owner/owners/" + ownerNo + "/parkingInfo",
                    method: "GET",
                    xhrFields: { withCredentials: true },
                    success: function(parkingInfos) {
                        if (parkingInfos.length > 0) {
                            $('.listings-list').empty(); // 清空現有列表

                            parkingInfos.forEach(function(info) {
                                if (info.parkingId) {
                                    var imageUrl = apiUrl + "/owner/owners/" + ownerNo + "/parkingInfo/" + info.parkingId + "/image";
                                    var parkingName = info.parkingName ? info.parkingName : "無名稱"; // 如果 parkingName 不存在，顯示 "無名稱"
                                    
                                    var listItem = `
                                        <li data-id="${info.parkingId}">
                                            <div class="list-box-listing">
                                                <div class="list-box-listing-img" style="width: 100%; max-width: 300px; height: 200px; overflow: hidden;">
                                                    <a href="#">
                                                        <img src="${imageUrl}" alt="" class="upload-image" data-id="${info.parkingId}" data-owner-no="${ownerNo}" onerror="this.onerror=null; this.src='${defaultImageUrl}';" style="width: 100%; height: 100%; object-fit: contain;">
                                                    </a>
                                                    <input type="file" class="image-upload-input" data-id="${info.parkingId}" data-owner-no="${ownerNo}" style="display: none;" accept="image/*">
                                                </div>
                                                <div class="list-box-listing-content">
                                                    <div class="inner">
                                                        <h3 class="parkingName"><a href="http://localhost:5500/dashboard-space.html?parkingId=${info.parkingId}">${parkingName}</a></h3>
                                                        <p class="parkingRegion">地區：${info.parkingRegion}</p>
                                                        <p class="parkingLocation">地址：${info.parkingLocation}</p>
                                                        <p class="capacity">車位總數：${info.capacity}</p>
                                                        <p class="holidayHourlyRate">假日收費：${info.holidayHourlyRate} 元</p>
                                                        <p class="workdayHourlyRate">平日收費：${info.workdayHourlyRate} 元</p>
                                                        <p class="parkingLong">經度：${info.parkingLong}</p>
                                                        <p class="parkingLat">緯度：${info.parkingLat}</p>
                                                    </div>
                                                    <!-- 使用表格進行水平排列，按鈕靠右顯示 -->
                                                    <table style="width: 100%; margin-top: 10px;">
                                                        <tr>
                                                            <td style="text-align: right;">
                                                                <a href="#" class="button gray edit-button" data-id="${info.parkingId}" data-owner-no="${ownerNo}"><i class="sl sl-icon-note"></i> 编辑</a>
                                                                <a href="#" class="button gray confirm-button" data-id="${info.parkingId}" style="display:none;"><i class="sl sl-icon-check"></i> 確定</a>
                                                                <a href="#" class="button gray upload-image-button" data-id="${info.parkingId}" data-owner-no="${ownerNo}"><i class="sl sl-icon-cloud-upload"></i> 上傳圖片</a>
                                                                <a href="#" class="button gray delete-button" data-id="${info.parkingId}" data-owner-no="${ownerNo}"><i class="sl sl-icon-close"></i> 删除</a>
                                                            </td>
                                                        </tr>
                                                    </table>
                                                </div>
                                            </div>
                                        </li>
                                    `;

                                    $('.listings-list').append(listItem);
                                }
                            });
                        } else {
                            $('.listings-list').append('<li>没有停车信息可用。</li>');
                        }
                    },
                    error: function() {
                        $('.listings-list').append('<li>获取停车信息失败。</li>');
                    }
                });
            },
            error: function() {
                $('.listings-list').append('<li>无法获取业主编号，请登录后重试。</li>');
            }
        });
    });
</script>







<!-- 上傳圖片功能 -->
<script>
    $(document).ready(function() {
        var apiUrl = "http://localhost:8081";

        // 點擊“上傳圖片”按鈕，觸發文件選擇框
        $('.listings-list').on('click', '.upload-image-button', function(e) {
            e.preventDefault();
            var parkingId = $(this).data('id');
            $(`.image-upload-input[data-id="${parkingId}"]`).click();
        });

        // 當用戶選擇新圖片時，上傳圖片
        $('.listings-list').on('change', '.image-upload-input', function(e) {
            var parkingId = $(this).data('id');
            var fileInput = $(this)[0];
            var ownerNo = $(this).data('owner-no'); 

            if (fileInput.files && fileInput.files[0]) {
                var formData = new FormData();
                formData.append("image", fileInput.files[0]);

                $.ajax({
                    url: `${apiUrl}/owner/owners/${ownerNo}/parkingInfo/${parkingId}/uploadImage`,
                    method: "POST",
                    data: formData,
                    processData: false,
                    contentType: false,
                    xhrFields: { withCredentials: true },
                    success: function() {
                        alert("圖片上傳成功！");
                        var timestamp = new Date().getTime();
                        var imageUrl = `${apiUrl}/owner/owners/${ownerNo}/parkingInfo/${parkingId}/image?t=${timestamp}`;
                        $(`.upload-image[data-id="${parkingId}"]`).attr("src", imageUrl);
                    },
                    error: function() {
                        alert("圖片上傳失敗，請稍後再試。");
                    }
                });
            }
        });
    });
</script>


<!-- 編輯功能 --> 
<script>
    $(document).ready(function() {
        var apiUrl = "http://localhost:8081";

        // 點擊“編輯”按鈕事件
        $('.listings-list').on('click', '.edit-button', function(e) {
            e.preventDefault();
            var listItem = $(this).closest('li');
            listItem.find('.parkingName').html(`<input type="text" value="${listItem.find('.parkingName').text()}" class="editable">`);
            listItem.find('.parkingRegion').html(`地區：<input type="text" value="${listItem.find('.parkingRegion').text().replace('地區：', '')}" class="editable">`);
            listItem.find('.parkingLocation').html(`地址：<input type="text" value="${listItem.find('.parkingLocation').text().replace('地址：', '')}" class="editable">`);
            listItem.find('.capacity').html(`車位總數：<input type="number" value="${listItem.find('.capacity').text().replace('車位總數：', '')}" class="editable">`);
            listItem.find('.holidayHourlyRate').html(`假日收費：<input type="number" value="${listItem.find('.holidayHourlyRate').text().replace('假日收費：', '').replace(' 元', '')}" class="editable"> 元`);
            listItem.find('.workdayHourlyRate').html(`平日收費：<input type="number" value="${listItem.find('.workdayHourlyRate').text().replace('平日收費：', '').replace(' 元', '')}" class="editable"> 元`);
            listItem.find('.parkingLong').html(`經度：<input type="number" step="0.000001" value="${listItem.find('.parkingLong').text().replace('經度：', '')}" class="editable">`);
            listItem.find('.parkingLat').html(`緯度：<input type="number" step="0.000001" value="${listItem.find('.parkingLat').text().replace('緯度：', '')}" class="editable">`);

            // 顯示“確定”按鈕，隱藏“編輯”按鈕
            listItem.find('.edit-button').hide();
            listItem.find('.confirm-button').show();
        });

        // 點擊“確定”按鈕事件，不更動圖片部分
        $('.listings-list').on('click', '.confirm-button', function(e) {
            e.preventDefault();
            var listItem = $(this).closest('li');
            var parkingId = $(this).data('id');
            var ownerNo = listItem.find('.upload-image').data('owner-no'); // 從圖片上獲取 ownerNo

            // 收集可編輯欄位的數據，順序按照 HTML 結構中的顯示順序
            var updatedData = {
                parkingName: listItem.find('input.editable:eq(0)').val(),
                parkingRegion: listItem.find('input.editable:eq(1)').val(),
                parkingLocation: listItem.find('input.editable:eq(2)').val(),
                capacity: parseInt(listItem.find('input.editable:eq(3)').val()),
                holidayHourlyRate: parseInt(listItem.find('input.editable:eq(4)').val()),
                workdayHourlyRate: parseInt(listItem.find('input.editable:eq(5)').val()),
                parkingLong: parseFloat(listItem.find('input.editable:eq(6)').val()),
                parkingLat: parseFloat(listItem.find('input.editable:eq(7)').val())
            };

            // 發送更新請求（不包含圖片部分）
            $.ajax({
                url: `${apiUrl}/owner/owners/${ownerNo}/parkingInfo/${parkingId}`,
                method: "PUT",
                contentType: "application/json",
                data: JSON.stringify(updatedData),
                xhrFields: { withCredentials: true },
                success: function() {
                    alert("停车场信息更新成功！");
                    // 更新後將可編輯輸入框轉換為普通文字
                    listItem.find('.parkingName').text(updatedData.parkingName);
                    listItem.find('.parkingRegion').text(`地區：${updatedData.parkingRegion}`);
                    listItem.find('.parkingLocation').text(`地址：${updatedData.parkingLocation}`);
                    listItem.find('.capacity').text(`車位總數：${updatedData.capacity}`);
                    listItem.find('.holidayHourlyRate').text(`假日收費：${updatedData.holidayHourlyRate} 元`);
                    listItem.find('.workdayHourlyRate').text(`平日收費：${updatedData.workdayHourlyRate} 元`);
                    listItem.find('.parkingLong').text(`經度：${updatedData.parkingLong}`);
                    listItem.find('.parkingLat').text(`緯度：${updatedData.parkingLat}`);

                    // 隱藏“確定”按鈕，顯示“編輯”按鈕
                    listItem.find('.confirm-button').hide();
                    listItem.find('.edit-button').show();
                },
                error: function() {
                    alert("更新停车场信息失败，请稍后再试。");
                }
            });
        });
    });
</script>


<!-- 刪除功能 -->
<script>
    $(document).ready(function() {
        var apiUrl = "http://localhost:8081";

        // 綁定刪除按鈕的事件處理
        $('.listings-list').on('click', '.delete-button', function(e) {
            e.preventDefault();
            var parkingId = $(this).data('id');
            var ownerNo = $(this).data('owner-no');

            $.ajax({
                url: `${apiUrl}/owner/owners/${ownerNo}/parkingInfo/${parkingId}`,
                method: "DELETE",
                xhrFields: { withCredentials: true },
                success: function() {
                    $(`li[data-id="${parkingId}"]`).remove();
                    alert("停车场信息已删除成功！");
                },
                error: function() {
                    alert("删除停车场信息失败，请稍后再试。");
                }
            });
        });
    });
</script>









<!-- Scripts
================================================== -->
<script type="text/javascript" src="scripts/jquery-3.6.0.min.js"></script>
<script type="text/javascript" src="scripts/jquery-migrate-3.3.2.min.js"></script>
<script type="text/javascript" src="scripts/mmenu.min.js"></script>
<script type="text/javascript" src="scripts/chosen.min.js"></script>
<script type="text/javascript" src="scripts/slick.min.js"></script>
<script type="text/javascript" src="scripts/rangeslider.min.js"></script>
<script type="text/javascript" src="scripts/magnific-popup.min.js"></script>
<script type="text/javascript" src="scripts/waypoints.min.js"></script>
<script type="text/javascript" src="scripts/counterup.min.js"></script>
<script type="text/javascript" src="scripts/jquery-ui.min.js"></script>
<script type="text/javascript" src="scripts/tooltips.min.js"></script>
<script type="text/javascript" src="scripts/custom.js"></script>


</body>
</html>